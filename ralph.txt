Refactor Plan: Per-Workspace Claude Code + OpenCode (No Host MCP Proxy)
======================================================================

Goal
----
Replace the host workspace bash tool + MCP proxy system with per-workspace installs
of Claude Code and OpenCode. Each agent runs inside the workspace so native bash
works and file effects are scoped to the correct workspace. Keep event streaming
visible in the UI.

Why this change
---------------
- Native bash is reliable only when the agent runs inside the target workspace.
- The current proxy system introduces ambiguity and bugs (cwd/path/state drift).
- Per-workspace installs allow strict isolation and predictable behavior.

Summary of required changes
---------------------------
Backend
- Add a workspace execution layer (host/chroot/ssh) that can spawn streaming
  processes inside the workspace (used by both Claude Code and OpenCode).
- Claude Code: spawn the CLI inside the workspace (not on host).
- OpenCode: run per-workspace server or run curl inside the workspace for /session
  and SSE /event streaming; avoid host HTTP into container networks.
- Track per-workspace runtime state: PID, port, status, last_event_at.

Workspace + Config
- Stop syncing workspace-mcp/desktop-mcp binaries into containers.
- Enable built-in bash in per-workspace configs; remove instructions that force
  mcp__workspace__bash.
- Copy per-workspace config into each workspace:
  - opencode.json
  - oh-my-opencode.json
  - provider auth / tokens (if needed)
- Add per-workspace overrides (CLI path, OpenCode port, plugin list, env vars).

UI
- Add per-workspace backend settings panel.
- Show per-workspace status: installed / running / version / last event.
- Fetch agents per workspace (not global).

Networking / Tailscale
- For isolated workspaces with private networking, host HTTP will fail.
- Fix: run OpenCode client requests inside the workspace (nspawn/ssh).

Test Instructions
=================

Pre-checks
- Create two workspaces:
  1) Isolated workspace (chroot)
  2) Host workspace
- Ensure per-workspace installs are present for both Claude Code and OpenCode
  in each workspace (the new flow should do this automatically).

Test 1: Claude Code in isolated workspace
----------------------------------------
Steps
1) In the UI, create a new mission with backend = Claude Code and workspace = isolated.
2) Send a prompt like: "Create a file named WORKSPACE_TEST_CLAUDE.txt with the content 'hello' in the current directory. Then list files."
3) Observe streaming events in UI.
4) Verify in the isolated workspace filesystem that the file exists.

Pass criteria
- Terminal/tool outputs stream in UI.
- File appears inside the isolated workspace directory.
- File does NOT appear in host workspace directory.

Test 2: OpenCode in isolated workspace
--------------------------------------
Steps
1) Create a mission with backend = OpenCode and workspace = isolated.
2) Send: "Create a file named WORKSPACE_TEST_OPENCODE.txt with the content 'hello' in the current directory. Then list files."
3) Observe streaming events.
4) Verify the file exists in the isolated workspace filesystem.

Pass criteria
- Tool calls and results stream in UI.
- File exists in isolated workspace.
- File does NOT appear in host workspace.

Test 3: Claude Code in host workspace
-------------------------------------
Steps
1) Create a mission with backend = Claude Code and workspace = host.
2) Send: "Create a file named HOST_TEST_CLAUDE.txt with the content 'hello' in the current directory. Then list files."
3) Verify file exists in host workspace directory.

Pass criteria
- File is created in host workspace.
- No file appears in isolated workspace.

Test 4: OpenCode in host workspace
----------------------------------
Steps
1) Create a mission with backend = OpenCode and workspace = host.
2) Send: "Create a file named HOST_TEST_OPENCODE.txt with the content 'hello' in the current directory. Then list files."
3) Verify file exists in host workspace directory.

Pass criteria
- File is created in host workspace.
- No file appears in isolated workspace.

Notes
-----
- If any file shows up in the wrong workspace, it means the agent or tool
  execution still runs on the host or is using the wrong cwd.
- If events do not stream, the in-workspace process spawning or SSE proxy is
  broken.
