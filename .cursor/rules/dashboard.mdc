---
description: Dashboard (Next.js + Bun) conventions
globs: ["dashboard/**"]
---

# Dashboard Conventions

## Package Manager: Bun (not npm/yarn/pnpm)

```bash
cd dashboard
bun install          # install deps
bun dev              # dev server on :3001
bun run build        # production build
bun add <package>    # add dependency (gets latest version)
```

## Stack

| Tech | Version | Purpose |
|------|---------|---------|
| Next.js | 16.x | React framework |
| React | 19.x | UI library |
| Tailwind | 4.x | Styling |
| Bun | 1.3+ | Package manager + runtime |
| xterm | 5.x | Terminal emulator |

## API Communication

```typescript
// All API calls go through lib/api.ts
const API_BASE = process.env.NEXT_PUBLIC_API_URL ?? 'http://127.0.0.1:3000';

// Auth: JWT stored in sessionStorage
const token = sessionStorage.getItem('jwt');
headers: { 'Authorization': `Bearer ${token}` }

// SSE streaming (uses fetch, not EventSource, for auth headers)
```

## Directory Structure

```
dashboard/src/
├── app/              # Next.js App Router pages
│   ├── console/      # SSH terminal + file explorer
│   ├── control/      # Task control panel
│   ├── agents/       # Agent tree visualization
│   ├── modules/      # MCP module management
│   └── settings/     # Configuration
├── components/
│   ├── ui/           # Generic UI components
│   ├── tool-ui/      # Tool-specific UI (option-list, data-table)
│   └── agent-tree/   # Agent tree visualization components
├── hooks/            # React hooks
└── lib/              # Utilities (api, auth, settings)
```

## Agent Tree Visualization

Dynamic, animated tree visualization for hierarchical agent execution. Uses SVG + framer-motion for smooth animations.

### Component Structure

```
components/agent-tree/
├── index.ts              # Public exports
├── types.ts              # Type definitions (AgentNode, LayoutNode, etc.)
├── layout.ts             # Tree layout algorithm (modified Reingold-Tilford)
├── demo-data.ts          # Demo tree generators for testing
└── AgentTreeCanvas.tsx   # Main visualization component
```

### Usage

```tsx
import { 
  AgentTreeCanvas, 
  generateComplexTree, 
  simulateTreeUpdates,
  type AgentNode 
} from '@/components/agent-tree';

// With real data from backend
<AgentTreeCanvas 
  tree={agentTree} 
  selectedNodeId={selectedId}
  onSelectNode={(node) => setSelectedId(node?.id ?? null)} 
/>

// Demo mode (for testing without API)
const [tree, setTree] = useState(generateComplexTree());
useEffect(() => simulateTreeUpdates(tree, setTree), []);
<AgentTreeCanvas tree={tree} />
```

### Node Display

Each node shows:
- **Icon**: Agent type (Bot, Brain, Cpu, Zap, Target, GitBranch)
- **Name**: Truncated agent name
- **Model**: LLM model used (e.g., `claude-sonnet-4.5`)
- **Status**: Running (pulse), Completed (✓), Failed (✗), Pending (clock)
- **Budget**: Spent / Allocated (e.g., `$0.35 / $9.00`)

### Demo Modes

Three demo tree generators for testing:
- `generateSimpleTree()` – Basic orchestrator (5 nodes)
- `generateComplexTree()` – Subtask decomposition (10-15 nodes)
- `generateDeepTree(depth)` – Recursive nesting (50+ nodes)

Use `simulateTreeUpdates(tree, setTree)` to simulate live status changes.

### Interactions

- **Pan**: Click and drag to move the tree
- **Zoom**: Mouse wheel or +/- buttons
- **Select**: Click a node to show details panel
- **Reset**: Reset view button restores initial position

## Environment Variables

Dashboard uses `.env.local`:
```
NEXT_PUBLIC_API_URL=http://127.0.0.1:3000
```

## Auth Flow

1. Dashboard checks `/api/health` for `auth_required`
2. If required, prompts password → `POST /api/auth/login`
3. Stores JWT + expiry in `sessionStorage`
4. Sends `Authorization: Bearer <jwt>` on all requests
5. WebSocket auth: uses subprotocol `["openagent", "jwt.<token>"]`

## Icons

Use Lucide React (`lucide-react`), not Remix Icons:
```tsx
import { Home, Settings, Play } from 'lucide-react';
<Home className="h-4 w-4" />
```

## Ports

| Service | Port |
|---------|------|
| Backend API | 3000 |
| Dashboard | 3001 |
