{
  "active": true,
  "iteration": 1,
  "maxIterations": 0,
  "completionPromise": "COMPLETE",
  "prompt": "Refactor Plan: Per-Workspace Claude Code + OpenCode (No Host MCP Proxy)\n======================================================================\n\nGoal\n----\nReplace the host workspace bash tool + MCP proxy system with per-workspace installs\nof Claude Code and OpenCode. Each agent runs inside the workspace so native bash\nworks and file effects are scoped to the correct workspace. Keep event streaming\nvisible in the UI.\n\nWhy this change\n---------------\n- Native bash is reliable only when the agent runs inside the target workspace.\n- The current proxy system introduces ambiguity and bugs (cwd/path/state drift).\n- Per-workspace installs allow strict isolation and predictable behavior.\n\nSummary of required changes\n---------------------------\nBackend\n- Add a workspace execution layer (host/chroot/ssh) that can spawn streaming\n  processes inside the workspace (used by both Claude Code and OpenCode).\n- Claude Code: spawn the CLI inside the workspace (not on host).\n- OpenCode: run per-workspace server or run curl inside the workspace for /session\n  and SSE /event streaming; avoid host HTTP into container networks.\n- Track per-workspace runtime state: PID, port, status, last_event_at.\n\nWorkspace + Config\n- Stop syncing workspace-mcp/desktop-mcp binaries into containers.\n- Enable built-in bash in per-workspace configs; remove instructions that force\n  mcp__workspace__bash.\n- Copy per-workspace config into each workspace:\n  - opencode.json\n  - oh-my-opencode.json\n  - provider auth / tokens (if needed)\n- Add per-workspace overrides (CLI path, OpenCode port, plugin list, env vars).\n\nUI\n- Add per-workspace backend settings panel.\n- Show per-workspace status: installed / running / version / last event.\n- Fetch agents per workspace (not global).\n\nNetworking / Tailscale\n- For isolated workspaces with private networking, host HTTP will fail.\n- Fix: run OpenCode client requests inside the workspace (nspawn/ssh).\n\nTest Instructions\n=================\n\nPre-checks\n- Create two workspaces:\n  1) Isolated workspace (chroot)\n  2) Host workspace\n- Ensure per-workspace installs are present for both Claude Code and OpenCode\n  in each workspace (the new flow should do this automatically).\n\nTest 1: Claude Code in isolated workspace\n----------------------------------------\nSteps\n1) In the UI, create a new mission with backend = Claude Code and workspace = isolated.\n2) Send a prompt like: \"Create a file named WORKSPACE_TEST_CLAUDE.txt with the content 'hello' in the current directory. Then list files.\"\n3) Observe streaming events in UI.\n4) Verify in the isolated workspace filesystem that the file exists.\n\nPass criteria\n- Terminal/tool outputs stream in UI.\n- File appears inside the isolated workspace directory.\n- File does NOT appear in host workspace directory.\n\nTest 2: OpenCode in isolated workspace\n--------------------------------------\nSteps\n1) Create a mission with backend = OpenCode and workspace = isolated.\n2) Send: \"Create a file named WORKSPACE_TEST_OPENCODE.txt with the content 'hello' in the current directory. Then list files.\"\n3) Observe streaming events.\n4) Verify the file exists in the isolated workspace filesystem.\n\nPass criteria\n- Tool calls and results stream in UI.\n- File exists in isolated workspace.\n- File does NOT appear in host workspace.\n\nTest 3: Claude Code in host workspace\n-------------------------------------\nSteps\n1) Create a mission with backend = Claude Code and workspace = host.\n2) Send: \"Create a file named HOST_TEST_CLAUDE.txt with the content 'hello' in the current directory. Then list files.\"\n3) Verify file exists in host workspace directory.\n\nPass criteria\n- File is created in host workspace.\n- No file appears in isolated workspace.\n\nTest 4: OpenCode in host workspace\n----------------------------------\nSteps\n1) Create a mission with backend = OpenCode and workspace = host.\n2) Send: \"Create a file named HOST_TEST_OPENCODE.txt with the content 'hello' in the current directory. Then list files.\"\n3) Verify file exists in host workspace directory.\n\nPass criteria\n- File is created in host workspace.\n- No file appears in isolated workspace.\n\nNotes\n-----\n- If any file shows up in the wrong workspace, it means the agent or tool\n  execution still runs on the host or is using the wrong cwd.\n- If events do not stream, the in-workspace process spawning or SSE proxy is\n  broken.\n",
  "startedAt": "2026-01-20T06:49:41.034Z",
  "model": "anthropic/claude-opus-4-5"
}